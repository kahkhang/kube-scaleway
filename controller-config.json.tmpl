{"ignition":{"version":"2.0.0","config":{}},"storage":{"files":[{"filesystem":"root","path":"/etc/traefik/acme/acme.json","contents":{"source":"data:,","verification":{}},"mode":384,"user":{},"group":{}},{"filesystem":"root","path":"/opt/bin/scw-metadata","contents":{"source":"data:,%23!%2Fbin%2Fsh%0A%23%20description%20%22executable%20which%20retrieves%20server%20metadata%20(TEXT)%22%0A%23%20author%20%22Scaleway%20%3Copensource%40scaleway.com%3E%22%0A%0Aexport%20PATH%3D%22%24%7BPATH%3A%2B%24PATH%3A%7D%2Fusr%2Fbin%3A%2Fbin%22%0A%0ACACHE_FILE%3D%2Frun%2Fscw-metadata.cache%0AMETADATA_IP%3D%24%7BMETADATA_IP%3A-169.254.42.42%7D%0AMETADATA_URL%3D%24%7BMETADATA_URL%3A-%22http%3A%2F%2F%24%7BMETADATA_IP%7D%2Fconf%22%7D%0A%0Aif%20%5B%20%22%241%22%20%3D%20%22--cached%22%20-a%20-f%20%24CACHE_FILE%20%5D%3B%20then%0A%20%20%20%20shift%0A%20%20%20%20BODY%3D%24(cat%20%24CACHE_FILE)%0Aelse%0A%20%20%20%20%5B%20%22%241%22%20%3D%20%22--cached%22%20%5D%20%26%26%20shift%0A%20%20%20%20if%20hash%20curl%202%3E%2Fdev%2Fnull%3B%20then%0A%20%20%20%20%20%20%20%20%23%20Using%20curl%0A%20%20%20%20%20%20%20%20CODE%3D0%0A%20%20%20%20%20%20%20%20while%20%5B%20%24CODE%20-ne%20200%20%5D%3B%20do%0A%20%20%20%20%20%20%20%20%20%20%20%20RESPONSE%3D%24(curl%20--noproxy%20'*'%20--silent%20--write-out%20%22%5Cn%25%7Bhttp_CODE%7D%5Cn%22%20%24METADATA_URL)%0A%20%20%20%20%20%20%20%20%20%20%20%20CODE%3D%24(echo%20%22%24RESPONSE%22%20%7C%20sed%20-n%20'%24p')%0A%20%20%20%20%20%20%20%20%20%20%20%20BODY%3D%24(echo%20%22%24RESPONSE%22%20%7C%20sed%20'%24d')%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20%5B%20%24CODE%20-eq%20200%20%5D%3B%20then%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20echo%20%22%24BODY%22%20%3E%20%2Frun%2Fscw-metadata.cache%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ln%20-s%20scw-metadata.cache%20%2Frun%2Foc-metadata.cache%202%3E%2Fdev%2Fnull%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20break%0A%20%20%20%20%20%20%20%20%20%20%20%20fi%0A%20%20%20%20%20%20%20%20%20%20%20%20sleep%205%0A%20%20%20%20%20%20%20%20done%0A%20%20%20%20else%0A%20%20%20%20%20%20%20%20%23%20Using%20wget%0A%20%20%20%20%20%20%20%20for%20i%20in%201%202%203%204%205%3B%20do%0A%20%20%20%20%20%20%20%20%20%20%20%20BODY%3D%24(wget%20--no-proxy%20--quiet%20-O-%20%24METADATA_URL)%0A%20%20%20%20%20%20%20%20%20%20%20%20echo%20%22%24BODY%22%20%7C%20grep%20PRIVATE_IP%20%3E%2Fdev%2Fnull%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20%5B%20%24%3F%20-eq%200%20%5D%3B%20then%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20echo%20%22%24BODY%22%20%3E%20%2Frun%2Fscw-metadata.cache%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ln%20-s%20scw-metadata.cache%20%2Frun%2Foc-metadata.cache%202%3E%2Fdev%2Fnull%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20break%0A%20%20%20%20%20%20%20%20%20%20%20%20fi%0A%20%20%20%20%20%20%20%20%20%20%20%20sleep%202%0A%20%20%20%20%20%20%20%20done%0A%20%20%20%20fi%0Afi%0A%0Aif%20%5B%20%22%24%23%22%20-ne%201%20%5D%3B%20then%0A%20%20%20%20echo%20%22%24BODY%22%0Aelse%0A%20%20%20%20key%3D%22%241%22%0A%20%20%20%20echo%20%22%24BODY%22%20%7C%20grep%20%22%5E%24key%3D%22%20%7C%20sed%20%22s%2F%5E%5B%5E%3D%5D*%3D%2F%2F%3Bs%2F%5E%5B'%5C%22%5D%2F%2F%3Bs%2F%5B'%5C%22%5D%24%2F%2F%22%0Afi%0A","verification":{}},"mode":493,"user":{},"group":{}},{"filesystem":"root","path":"/opt/bin/scw-userdata","contents":{"source":"data:,%23!%2Fbin%2Fsh%0A%23%20description%20%22executable%20which%20retrieves%20server%20userdata%20(TEXT)%22%0A%23%20author%20%22Scaleway%20%3Copensource%40scaleway.com%3E%22%0A%0Aexport%20PATH%3D%22%24%7BPATH%3A%2B%24PATH%3A%7D%2Fusr%2Fbin%3A%2Fbin%22%0A%0AUSERDATA_IP%3D%24%7BUSERDATA_IP%3A-169.254.42.42%7D%0AUSERDATA_URL%3D%24%7BUSERDATA_URL%3A-%22http%3A%2F%2F%24%7BUSERDATA_IP%7D%2Fuser_data%22%7D%0A%0Aget()%20%7B%0A%20%20%20%20URL%3D%241%0A%20%20%20%20if%20type%20curl%20%3E%2Fdev%2Fnull%202%3E%2Fdev%2Fnull%3B%20then%0A%20%20%20%20%20%20%20%20%23%20Using%20curl%0A%20%20%20%20%20%20%20%20RESPONSE%3D%24(curl%20--local-port%201-1024%20--noproxy%20'*'%20--silent%20--write-out%20%22%5Cn%25%7Bhttp_CODE%7D%5Cn%22%20%24URL)%0A%20%20%20%20%20%20%20%20CODE%3D%24(echo%20%22%24RESPONSE%22%20%7C%20sed%20-n%20'%24p')%0A%20%20%20%20%20%20%20%20BODY%3D%24(echo%20%22%24RESPONSE%22%20%7C%20sed%20'%24d')%0A%20%20%20%20%20%20%20%20echo%20%22%24BODY%22%0A%20%20%20%20else%0A%20%20%20%20%20%20%20%20echo%20%22'curl'%20dependency%20is%20missing.%22%20%3E%262%0A%20%20%20%20fi%0A%7D%0A%0Apatch()%20%7B%0A%20%20%20%20URL%3D%22%241%22%0A%20%20%20%20DATA%3D%22%242%22%0A%20%20%20%20if%20type%20curl%20%3E%2Fdev%2Fnull%202%3E%2Fdev%2Fnull%3B%20then%0A%20%20%20%20%20%20%20%20%23%20Using%20curl%0A%20%20%20%20%20%20%20%20RESPONSE%3D%24(curl%20--local-port%201-1024%20--noproxy%20'*'%20-X%20PATCH%20-d%20%22%24DATA%22%20-H%20%22Content-Type%3A%20text%2Fplain%22%20--silent%20--write-out%20%22%5Cn%25%7Bhttp_CODE%7D%5Cn%22%20%24URL)%0A%20%20%20%20else%0A%20%20%20%20%20%20%20%20echo%20%22'curl'%20dependency%20is%20missing.%22%20%3E%262%0A%20%20%20%20fi%0A%7D%0A%0Aif%20%5B%20%22%241%22%20%3D%20%22%22%20%5D%3B%20then%0A%20%20%20%20get%20%22%24USERDATA_URL%2F%22%0Aelse%0A%20%20%20%20if%20%5B%20%22%242%22%20%3D%20%22%22%20%5D%3B%20then%0A%20%20%20%20%20%20%20%20get%20%22%24USERDATA_URL%2F%241%22%0A%20%20%20%20else%0A%20%20%20%20%20%20%20%20patch%20%22%24USERDATA_URL%2F%241%22%20%22%242%22%0A%20%20%20%20fi%0Afi%0A","verification":{}},"mode":493,"user":{},"group":{}},{"filesystem":"root","path":"/home/core/bootstrap.sh","contents":{"source":"data:,%23!%2Fusr%2Fbin%2Fenv%20bash%0Aset%20-euo%20pipefail%0A%0ACLUSTER_DIR%3D%24%7BCLUSTER_DIR%3A-cluster%7D%0ASELF_HOST_ETCD%3D%24%7BSELF_HOST_ETCD%3A-false%7D%0ACLOUD_PROVIDER%3D%24%7BCLOUD_PROVIDER%3A-%7D%0ANETWORK_PROVIDER%3D%24%7BNETWORK_PROVIDER%3A-flannel%7D%0A%0Afunction%20usage()%20%7B%0A%20%20%20%20echo%20%22USAGE%3A%22%0A%20%20%20%20echo%20%22%240%3A%20%3Cremote-host%3E%22%0A%20%20%20%20exit%201%0A%7D%0A%0Afunction%20configure_etcd()%20%7B%0A%20%20%20%20%5B%20-f%20%22%2Fetc%2Fsystemd%2Fsystem%2Fetcd-member.service.d%2F10-etcd-member.conf%22%20%5D%20%7C%7C%20%7B%0A%20%20%20%20%20%20%20%20mkdir%20-p%20%2Fetc%2Fetcd%2Ftls%0A%20%20%20%20%20%20%20%20cp%20%2Fhome%2Fcore%2Fassets%2Ftls%2Fetcd-*%20%2Fetc%2Fetcd%2Ftls%0A%20%20%20%20%20%20%20%20mkdir%20-p%20%2Fetc%2Fetcd%2Ftls%2Fetcd%0A%20%20%20%20%20%20%20%20cp%20%2Fhome%2Fcore%2Fassets%2Ftls%2Fetcd%2F*%20%2Fetc%2Fetcd%2Ftls%2Fetcd%0A%20%20%20%20%20%20%20%20chown%20-R%20etcd%3Aetcd%20%2Fetc%2Fetcd%0A%20%20%20%20%20%20%20%20chmod%20-R%20u%3DrX%2Cg%3D%2Co%3D%20%2Fetc%2Fetcd%0A%20%20%20%20%20%20%20%20mkdir%20-p%20%2Fetc%2Fsystemd%2Fsystem%2Fetcd-member.service.d%0A%20%20%20%20%20%20%20%20cat%20%3C%3C%20EOF%20%3E%20%2Fetc%2Fsystemd%2Fsystem%2Fetcd-member.service.d%2F10-etcd-member.conf%0A%5BService%5D%0AEnvironment%3D%22ETCD_IMAGE_TAG%3Dv3.1.8%22%0AEnvironment%3D%22ETCD_NAME%3Dcontroller%22%0AEnvironment%3D%22ETCD_INITIAL_CLUSTER%3Dcontroller%3Dhttps%3A%2F%2F%24%7BCOREOS_PRIVATE_IPV4%7D%3A2380%22%0AEnvironment%3D%22ETCD_INITIAL_ADVERTISE_PEER_URLS%3Dhttps%3A%2F%2F%24%7BCOREOS_PRIVATE_IPV4%7D%3A2380%22%0AEnvironment%3D%22ETCD_ADVERTISE_CLIENT_URLS%3Dhttps%3A%2F%2F%24%7BCOREOS_PRIVATE_IPV4%7D%3A2379%22%0AEnvironment%3D%22ETCD_LISTEN_CLIENT_URLS%3Dhttps%3A%2F%2F0.0.0.0%3A2379%22%0AEnvironment%3D%22ETCD_LISTEN_PEER_URLS%3Dhttps%3A%2F%2F0.0.0.0%3A2380%22%0AEnvironment%3D%22ETCD_SSL_DIR%3D%2Fetc%2Fetcd%2Ftls%22%0AEnvironment%3D%22ETCD_TRUSTED_CA_FILE%3D%2Fetc%2Fssl%2Fcerts%2Fetcd%2Fserver-ca.crt%22%0AEnvironment%3D%22ETCD_CERT_FILE%3D%2Fetc%2Fssl%2Fcerts%2Fetcd%2Fserver.crt%22%0AEnvironment%3D%22ETCD_KEY_FILE%3D%2Fetc%2Fssl%2Fcerts%2Fetcd%2Fserver.key%22%0AEnvironment%3D%22ETCD_CLIENT_CERT_AUTH%3Dtrue%22%0AEnvironment%3D%22ETCD_PEER_TRUSTED_CA_FILE%3D%2Fetc%2Fssl%2Fcerts%2Fetcd%2Fpeer-ca.crt%22%0AEnvironment%3D%22ETCD_PEER_CERT_FILE%3D%2Fetc%2Fssl%2Fcerts%2Fetcd%2Fpeer.crt%22%0AEnvironment%3D%22ETCD_PEER_KEY_FILE%3D%2Fetc%2Fssl%2Fcerts%2Fetcd%2Fpeer.key%22%0AEOF%0A%20%20%20%20%7D%0A%7D%0A%0A%23%20Initialize%20a%20Master%20node%0Afunction%20init_master_node()%20%7B%0A%20%20%20%20systemctl%20daemon-reload%0A%20%20%20%20systemctl%20stop%20locksmithd%3B%20systemctl%20mask%20locksmithd%0A%0A%20%20%20%20if%20%5B%20%22%24SELF_HOST_ETCD%22%20%3D%20true%20%5D%20%3B%20then%0A%20%20%20%20%20%20%20%20echo%20%22WARNING%3A%20THIS%20IS%20NOT%20YET%20FULLY%20WORKING%20-%20merely%20here%20to%20make%20ongoing%20testing%20easier%22%0A%20%20%20%20%20%20%20%20etcd_render_flags%3D%22--experimental-self-hosted-etcd%22%0A%20%20%20%20else%0A%20%20%20%20%20%20%20%20etcd_render_flags%3D%22--etcd-servers%3Dhttps%3A%2F%2F%24%7BCOREOS_PRIVATE_IPV4%7D%3A2379%22%0A%20%20%20%20fi%0A%0A%20%20%20%20if%20%5B%20%22%24NETWORK_PROVIDER%22%20%3D%20%22canal%22%20%5D%3B%20then%0A%20%20%20%20%20%20%20%20network_provider_flags%3D%22--network-provider%3Dexperimental-canal%22%0A%20%20%20%20elif%20%5B%20%22%24NETWORK_PROVIDER%22%20%3D%20%22calico%22%20%5D%3B%20then%0A%20%20%20%20%20%20%20%20network_provider_flags%3D%22--network-provider%3Dexperimental-calico%22%0A%20%20%20%20else%0A%20%20%20%20%20%20%20%20network_provider_flags%3D%22--network-provider%3Dflannel%22%0A%20%20%20%20fi%0A%0A%20%20%20%20%23%20Render%20cluster%20assets%0A%20%20%20%20%2Fhome%2Fcore%2Fbootkube%20render%20--asset-dir%3D%2Fhome%2Fcore%2Fassets%20%24%7Betcd_render_flags%7D%20%24%7Bnetwork_provider_flags%7D%20%5C%0A%20%20%20%20%20%20--api-servers%3Dhttps%3A%2F%2F%24%7BCOREOS_PUBLIC_IPV4%7D%3A6443%2Chttps%3A%2F%2F%24%7BCOREOS_PRIVATE_IPV4%7D%3A6443%0A%0A%20%20%20%20%23%20Move%20the%20local%20kubeconfig%20into%20expected%20location%0A%20%20%20%20chown%20-R%20core%3Acore%20%2Fhome%2Fcore%2Fassets%0A%20%20%20%20mkdir%20-p%20%2Fetc%2Fkubernetes%0A%20%20%20%20cp%20%2Fhome%2Fcore%2Fassets%2Fauth%2Fkubeconfig%20%2Fetc%2Fkubernetes%2F%0A%20%20%20%20cp%20%2Fhome%2Fcore%2Fassets%2Ftls%2Fca.crt%20%2Fetc%2Fkubernetes%2Fca.crt%0A%0A%20%20%20%20%23%20Start%20etcd.%0A%20%20%20%20if%20%5B%20%22%24SELF_HOST_ETCD%22%20%3D%20false%20%5D%20%3B%20then%0A%20%20%20%20%20%20%20%20configure_etcd%0A%20%20%20%20%20%20%20%20systemctl%20enable%20etcd-member%3B%20sudo%20systemctl%20start%20etcd-member%0A%20%20%20%20fi%0A%0A%20%20%20%20%23%20Set%20cloud%20provider%0A%20%20%20%20sed%20-i%20%22s%2Fcloud-provider%3D%2Fcloud-provider%3D%24CLOUD_PROVIDER%2F%22%20%2Fetc%2Fsystemd%2Fsystem%2Fkubelet.service%0A%0A%20%20%20%20%23%20Start%20the%20kubelet%0A%20%20%20%20systemctl%20enable%20kubelet%3B%20sudo%20systemctl%20start%20kubelet%0A%0A%20%20%20%20%23%20Start%20bootkube%20to%20launch%20a%20self-hosted%20cluster%0A%20%20%20%20%2Fhome%2Fcore%2Fbootkube%20start%20--asset-dir%3D%2Fhome%2Fcore%2Fassets%0A%7D%0A%0A%5B%20-d%20%22%24%7BCLUSTER_DIR%7D%22%20%5D%20%26%26%20%7B%0A%20%20%20%20echo%20%22Error%3A%20CLUSTER_DIR%3D%24%7BCLUSTER_DIR%7D%20already%20exists%22%0A%20%20%20%20exit%201%0A%7D%0A%0Awget%20-P%20%2Fhome%2Fcore%20https%3A%2F%2Fgithub.com%2Fkubernetes-incubator%2Fbootkube%2Freleases%2Fdownload%2Fv0.9.1%2Fbootkube.tar.gz%0Atar%20-xzvf%20%2Fhome%2Fcore%2Fbootkube.tar.gz%20-C%20%2Fhome%2Fcore%0Amv%20%2Fhome%2Fcore%2Fbin%2Flinux%2Fbootkube%20.%0Achmod%20%2Bx%20%2Fhome%2Fcore%2Fbootkube%0Arm%20-rf%20%2Fhome%2Fcore%2Fbin%0A%0Ainit_master_node%0A","verification":{}},"mode":493,"user":{},"group":{}}]},"systemd":{"units":[{"name":"scw-signal-boot.service","enable":true,"contents":"[Unit]\nDescription=Signals a successfull boot to Scaleways monitor\nAfter=network-online.target systemd-networkd-wait-online.service\nRequires=network-online.target systemd-networkd-wait-online.service\n\n[Service]\nType=oneshot\nRemainAfterExit=true\nExecStart=/bin/curl \\\n  --fail --silent --show-error --location \\\n  --connect-timeout 1 --max-time 5 \\\n  -X PATCH -H 'Content-Type: application/json' \\\n  http://169.254.42.42/state \\\n  -d '{\"state_detail\": \"booted\"}'\n\n[Install]\nWantedBy=multi-user.target\n"},{"name":"scw-set-environment-file.service","enable":true,"contents":"[Unit]\nDescription=Converts Scaleways metadata to /etc/environment\nAfter=network-online.target systemd-networkd-wait-online.service\nRequires=network-online.target systemd-networkd-wait-online.service\n\n[Service]\nType=oneshot\nEnvironment=PATH=/opt/sbin:/opt/bin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\nExecStart=/usr/bin/bash -c \"\\\n  /opt/bin/scw-metadata | \\\n  grep -F -e 'PUBLIC_IP_ADDRESS' -e 'IPV6' -e 'PRIVATE_IP' -e 'HOSTNAME' | \\\n  sed -e 's/^HOSTNAME/SCW_HOSTNAME/;s/^PUBLIC_IP_ADDRESS/COREOS_PUBLIC_IPV4/;s/^PRIVATE_IP/COREOS_PRIVATE_IPV4/;s/^IPV6/COREOS_PUBLIC_IPV6/' | \\\n  sort \u003e/etc/environment\"\n\n[Install]\nWantedBy=multi-user.target\n"},{"name":"scw-set-hostname.service","enable":true,"contents":"[Unit]\nDescription=Sets the hostname according to /etc/environment\nAfter=scw-set-environment-file.service\nRequires=scw-set-environment-file.service\n\n[Service]\nType=oneshot\nRemainAfterExit=true\nEnvironmentFile=/etc/environment\nExecStart=/usr/bin/hostnamectl set-hostname \"$SCW_HOSTNAME\"\n\n[Install]\nWantedBy=multi-user.target\n"},{"name":"kubelet.service","enable":true,"contents":"[Service]\nEnvironment=KUBELET_IMAGE_URL=docker://gcr.io/google_containers/hyperkube\nEnvironment=KUBELET_IMAGE_TAG=v1.8.5\nEnvironment=PATH=/opt/bin/:/usr/bin/:/usr/sbin:$PATH\nEnvironment=\"RKT_RUN_ARGS=\\\n--uuid-file-save=/var/cache/kubelet-pod.uuid \\\n--volume etc-resolv,kind=host,source=/etc/resolv.conf --mount volume=etc-resolv,target=/etc/resolv.conf \\\n--volume opt-cni-bin,kind=host,source=/opt/cni/bin --mount volume=opt-cni-bin,target=/opt/cni/bin \\\n--volume var-log,kind=host,source=/var/log --mount volume=var-log,target=/var/log \\\n--volume var-lib-cni,kind=host,source=/var/lib/cni --mount volume=var-lib-cni,target=/var/lib/cni \\\n--insecure-options=image\"\nEnvironmentFile=/etc/environment\nExecStartPre=/bin/mkdir -p /etc/kubernetes/manifests\nExecStartPre=/bin/mkdir -p /opt/cni/bin\nExecStartPre=/bin/mkdir -p /etc/kubernetes/cni/net.d\nExecStartPre=/bin/mkdir -p /etc/kubernetes/checkpoint-secrets\nExecStartPre=/bin/mkdir -p /etc/kubernetes/inactive-manifests\nExecStartPre=/bin/mkdir -p /var/lib/cni\nExecStartPre=/bin/mkdir -p /var/lib/kubelet/volumeplugins\nExecStartPre=-/usr/bin/rkt rm --uuid-file=/var/cache/kubelet-pod.uuid\nExecStart=/usr/lib/coreos/kubelet-wrapper \\\n  --allow-privileged \\\n  --anonymous-auth=false \\\n  --client-ca-file=/etc/kubernetes/ca.crt \\\n  --cloud-provider= \\\n  --cluster_dns=10.3.0.10 \\\n  --cluster_domain=cluster.local \\\n  --cni-conf-dir=/etc/kubernetes/cni/net.d \\\n  --exit-on-lock-contention \\\n  --hostname-override=${COREOS_PUBLIC_IPV4} \\\n  --kubeconfig=/etc/kubernetes/kubeconfig \\\n  --lock-file=/var/run/lock/kubelet.lock \\\n  --minimum-container-ttl-duration=3m0s \\\n  --network-plugin=cni \\\n  --node-labels=node-role.kubernetes.io/master \\\n  --pod-manifest-path=/etc/kubernetes/manifests \\\n  --register-with-taints=node-role.kubernetes.io/master=:NoSchedule \\\n  --require-kubeconfig \\\n  --volume-plugin-dir=/var/lib/kubelet/volumeplugins\nExecStop=-/usr/bin/rkt stop --uuid-file=/var/cache/kubelet-pod.uuid\nRestart=always\nRestartSec=5\n\n[Install]\nWantedBy=multi-user.target\n"}]},"networkd":{"units":[{"name":"00-eth0.network","contents":"[Match]\nName=eth0\n\n[Network]\nDHCP=yes\nDNS=10.1.31.38\nDNS=10.1.31.39\nDomains=scaleway.com\n"}]},"passwd":{"users":[{"name":"core","sshAuthorizedKeys":["$SSH_KEY"]}]}}